# SPDX-FileCopyrightText: Â© 2025 Phala Network <dstack@phala.network>
#
# SPDX-License-Identifier: Apache-2.0

services:
  gateway:
    image: aghia/dstack-gateway-local:latest
    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock
      - /dstack:/dstack
      - data:/data
    network_mode: host
    privileged: true
    environment:
      - WG_ENDPOINT=${WG_ENDPOINT}
      - MY_URL=${MY_URL}
      - BOOTNODE_URL=${BOOTNODE_URL}
      - PROXY_BASE_DOMAIN=${PROXY_BASE_DOMAIN}
      - WG_IP=${WG_IP}
      - WG_RESERVED_NET=${WG_RESERVED_NET}
      - WG_CLIENT_RANGE=${WG_CLIENT_RANGE}
      - SUBNET_INDEX=${SUBNET_INDEX}
      - NODE_ID=${NODE_ID}
      - RUST_LOG=info,certbot=debug
      - PCCS_URL=${PCCS_URL}
      - RPC_DOMAIN=${RPC_DOMAIN}
      - PROXY_LISTEN_PORT=${PROXY_LISTEN_PORT:-443}
      - PROXY_WORKERS=${PROXY_WORKERS:-32}
      - MAX_CONNECTIONS_PER_APP=${MAX_CONNECTIONS_PER_APP:-0}
      - SYNC_INTERVAL=${SYNC_INTERVAL:-1m}
      - SYNC_TIMEOUT=${SYNC_TIMEOUT:-2m}
      - SYNC_PERSIST_INTERVAL=${SYNC_PERSIST_INTERVAL:-5m}
      - SYNC_CONNECTIONS_ENABLED=${SYNC_CONNECTIONS_ENABLED:-true}
      - SYNC_CONNECTIONS_INTERVAL=${SYNC_CONNECTIONS_INTERVAL:-30s}
      - TIMEOUT_CONNECT=${TIMEOUT_CONNECT:-5s}
      - TIMEOUT_HANDSHAKE=${TIMEOUT_HANDSHAKE:-5s}
      - TIMEOUT_CACHE_TOP_N=${TIMEOUT_CACHE_TOP_N:-30s}
      - TIMEOUT_DNS_RESOLVE=${TIMEOUT_DNS_RESOLVE:-5s}
      - TIMEOUT_DATA_ENABLED=${TIMEOUT_DATA_ENABLED:-true}
      - TIMEOUT_IDLE=${TIMEOUT_IDLE:-10m}
      - TIMEOUT_WRITE=${TIMEOUT_WRITE:-5s}
      - TIMEOUT_SHUTDOWN=${TIMEOUT_SHUTDOWN:-5s}
      - TIMEOUT_TOTAL=${TIMEOUT_TOTAL:-5h}
      - ADMIN_LISTEN_ADDR=${ADMIN_LISTEN_ADDR:-0.0.0.0}
      - ADMIN_LISTEN_PORT=${ADMIN_LISTEN_PORT:-8001}
    restart: always

volumes:
  data:
